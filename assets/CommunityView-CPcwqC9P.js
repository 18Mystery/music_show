import{_ as be,a as Fe,r as h,h as Se,x as se,c as i,d as o,e as u,w as f,y as B,u as xe,g as _,l as oe,b as I,o as c,F as N,i as L,z as b,t as d,q as k,n as v,A as Ne,B as te,f as ae,C as Le,p as $e,v as Re,D as Te,s as r}from"./index-Cshm0C-f.js";import{_ as De,a as ne,b as le}from"./comcomment-CiR7vvb2.js";import{_ as ie}from"./playMy-FspMaofR.js";import{_ as ce}from"./collect-active-BZg33xkB.js";import{_ as re}from"./collect-uw9KXPlZ.js";const Ee={class:"content"},Pe=["onClick"],Ue={class:"item"},Ve={class:"title"},Me={class:"left"},Ae={class:"icon"},Be=["src"],ze={class:"name"},Oe={key:0,class:"my-post"},Ke={class:"release-time"},Ge={class:"right"},je=["onClick"],qe={class:"desc"},Ye={class:"song"},Je={class:"photo"},We=["onClick"],He={key:0,src:ie,alt:"播放"},Qe={key:1,src:le,alt:"暂停"},Xe=["src"],Ze={class:"info"},es={class:"songname"},ss={class:"singer"},os=["onClick"],ts={key:0,src:ce,alt:"已收藏"},as={key:1,src:re,alt:"未收藏"},ns={class:"function"},ls=["onClick"],is={class:"btn"},cs=["onClick"],rs={key:0,class:"message"},ds=["onClick"],_s={class:"item"},us={class:"title"},vs={class:"left"},ms={class:"icon"},gs=["src"],hs={class:"name"},ps={class:"release-time"},fs={class:"desc"},ys={class:"song"},ks={class:"photo"},ws=["onClick"],Cs={key:0,src:ie,alt:"播放"},Is={key:1,src:le,alt:"暂停"},bs=["src"],Fs={class:"info"},Ss={class:"songname"},xs={class:"singer"},Ns=["onClick"],Ls={key:0,src:ce,alt:"已收藏"},$s={key:1,src:re,alt:"未收藏"},Rs={class:"function"},Ts=["onClick"],Ds={class:"btn"},Es=["onClick"],Ps={key:0,class:"message"},Us={class:"comment-content"},Vs={class:"total-comments"},Ms={class:"total-number"},As={class:"comment-list"},Bs=["onClick"],zs={class:"left"},Os=["src","alt"],Ks={class:"right"},Gs={class:"name-time"},js={class:"name"},qs={key:0,class:"my-comments"},Ys={class:"time"},Js=["onClick"],Ws={class:"user-comment"},Hs={key:0,class:"replies"},Qs={class:"reply-list"},Xs=["onClick"],Zs=["src"],eo={class:"reply-content"},so={class:"name-time"},oo={class:"name"},to={key:0,class:"my-comments"},ao={class:"time"},no=["onClick"],lo={class:"user-comment"},io={key:0,class:"reply-to"},co={style:{color:"#707070"}},ro={class:"reply-comment"},_o=["onClick"],uo={class:"input-box"},vo={class:"left-box"},mo=["src"],go={class:"middle-box"},ho=["placeholder"],po={__name:"CommunityView",setup(fo){const z=xe(),U=Fe(),g=localStorage.getItem("TOKEN"),m=h([]),S=h(!0),O=h(!0),x=h([]),$=h(!1),F=h(""),p=h(null),de=localStorage.getItem("USERIMG"),V=localStorage.getItem("USER_NAME"),y=localStorage.getItem("USER_ID"),R=h(!1),w=h(null),K=h(0),D=h([]),T=h(!1),G=()=>{setTimeout(()=>{A(),T.value=!1},1e3)},j=s=>{z.push({name:"userDetail",params:{userId:s}})},q=({position:s},e)=>{switch(console.log("删除当前的社区：",e),s){case"right":return e.user_id==y?new Promise(a=>{se({title:"确定删除吗？",confirmButtonColor:"#20a162"}).then(async()=>{try{(await _.deleteCommunityDynamics({token:g,postId:Number(e.post_id)})).code===200?(r("删除成功"),await A(),a(!0)):(r({type:"fail",message:"删除失败"}),a(!1))}catch(l){console.error("删除失败:",l),r({type:"fail",message:"删除失败"}),a(!1)}}).catch(()=>{a(!1)})}):!1;default:return!1}},Y=async s=>{try{s.isLiked?await _.removeLike({token:g,postId:s.post_id,userId:s.user_id}).then(e=>{console.log("取消点赞成功",e),e.code===200&&(s.isLiked=!1,s.like_count-=1,r("取消点赞成功"))}).catch(e=>{console.error("取消点赞失败:",e),r("取消点赞失败")}):await _.addLike({token:g,postId:s.post_id,userId:s.user_id}).then(e=>{console.log("点赞成功",e),e.code===200&&(s.isLiked=!0,s.like_count+=1,r("点赞成功"))}).catch(e=>{console.error("点赞失败:",e),r("点赞失败")})}catch(e){console.error("点赞操作失败:",e),r("操作失败")}},_e=s=>{p.value={type:"parent",id:s.id,name:s.user_name},R.value=!0},ue=s=>{p.value={type:"child",id:s.id,name:s.user_name},R.value=!0},E=async s=>{try{const e=await _.getCommentsWithReplies({token:g,postId:s.post_id});if(console.log("获取评论列表结果：",e),e.code===200){x.value=e.data.data;for(const a of x.value)if(a.created_at=M(a.created_at),a.user_avatar=_.host+a.user_avatar,a.postAuthorId=s.user_id,a.replies&&a.replies.length>0){for(const l of a.replies)if(l.created_at=M(l.created_at),l.user_avatar=_.host+l.user_avatar,l.postAuthorId=s.user_id,l.reply_to_replyId){const C=a.replies.find(P=>P.id===l.reply_to_replyId);C&&(l.reply_to_user_name=C.user_name,l.reply_to_user_avatar=C.user_avatar)}}console.log("评论列表：",x.value)}else r({type:"fail",message:"获取评论失败"})}catch(e){console.error("获取评论失败:",e),r({type:"fail",message:"获取评论失败"})}},J=async s=>{w.value=s,$.value=!$.value,$.value&&(R.value=!1,await E(s))},W=async()=>{if(!F.value.trim()){r({message:"请输入评论内容"});return}try{p.value?p.value.type==="parent"?(await _.addChildComment({token:g,commentId:p.value.id,userId:y,content:F.value})).code===200&&(r("回复成功"),w.value.comment_count+=1):p.value.type==="child"&&(await _.addChildCommentReply({token:g,replyId:p.value.id,userId:y,content:F.value})).code===200&&r("回复成功"):(await _.addParentComment({token:g,postId:w.value.post_id,userId:y,content:F.value})).code===200&&(r("评论成功"),w.value.comment_count+=1),await E(w.value),F.value="",R.value=!1,p.value=null}catch(s){console.error("提交评论失败:",s),r({type:"fail",message:"提交失败"})}},ve=async s=>{try{const e=await _.deleteComment({commentId:s});console.log("删除评论结果：",e),e.code===200?(w.value.comment_count-=1,await E(w.value),r({type:"success",message:"删除评论成功"})):r({type:"fail",message:"删除评论失败"})}catch(e){console.error("删除评论失败:",e),r({type:"fail",message:"删除评论失败"})}},me=async s=>{try{const e=await _.deleteChildComment({replyId:s});console.log("删除子评论结果：",e),e.code===200?(await E(w.value),r({type:"success",message:"删除子评论成功"})):r({type:"fail",message:"删除子评论失败"})}catch(e){console.error("删除子评论失败:",e),r({type:"fail",message:"删除子评论失败"})}},ge=s=>{s.expanded=!s.expanded};function he(){O.value||console.log("正在加载中...")}const M=s=>{const e=new Date(s),l=(new Date-e)/1e3;return l<60?s="刚刚":l<3600?s=Math.floor(l/60)+"分钟前":l<86400?s=Math.floor(l/3600)+"小时前":l<2592e3?s=Math.floor(l/86400)+"天前":l<31536e3?s=Math.floor(l/2592e3)+"月前":s=Math.floor(l/31536e3)+"年前",s},A=async()=>{try{const s=await _.getCommunityDynamics({token:g});if(s.code===200){let e=s.result;for(const a of e){const l=a.album_id,C=await oe.getAlbumContent(l);a.album_name=C.album.name,a.song_num=C.album.size,a.user_avatar=_.host+a.user_avatar,a.isFavorite=!1,a.isPlaying=!1,a.created_at=M(a.created_at),a.isLiked=!1,a.like_count=a.like_count||0}m.value=e,console.log("广场社区动态列表：",m.value),D.value=m.value.filter(a=>a.user_id==y),console.log("我的社区动态列表：",D.value),S.value=!1,H(),fe(),pe()}}catch(s){console.error("请求失败：",s)}},pe=async()=>{for(const s of m.value)try{const e=await _.checkLikeStatus({token:g,postId:s.post_id,userId:s.user_id});e.code===200&&(s.isLiked=e.isLiked)}catch(e){console.error("检查点赞状态失败:",e)}console.log("更新点赞状态：",m.value)},H=async()=>{for(const s of m.value)try{const e=await _.checkFollowUserStatus({token:g,followedId:s.user_id});e.code===200&&(s.isFollowing=e.isFollowing)}catch(e){console.error("检查关注状态失败:",e)}console.log("更新关注状态：",m.value)},fe=async()=>{for(const s of m.value)try{const e=await _.checkFavoriteStatus({token:localStorage.getItem("TOKEN"),songId:s.song_id});e.code===200&&(s.isFavorite=e.isFavorite)}catch(e){console.error("检查收藏状态失败:",e)}console.log("更新收藏状态：",m.value)},Q=async s=>{console.log("当前点击的歌曲：",s);try{s.isPlaying=!s.isPlaying,s.isPlaying?(U.addToNextInplayList(s),U.playSong(s),localStorage.setItem("CURRENT_PLAYING_SONG",JSON.stringify({song_id:s.song_id,isPlaying:!0}))):(U.pauseSong(),localStorage.removeItem("CURRENT_PLAYING_SONG")),m.value.forEach(e=>{e.song_id!==s.song_id&&(e.isPlaying=!1)}),console.log("播放状态更新成功：",s)}catch(e){console.error("播放操作失败：",e)}},ye=async s=>{console.log("关注用户ID：",s),H();try{const e=m.value.find(a=>a.user_id===s);e&&(e.isFollowing?(await _.removeFollow({token:g,followedId:s}),e.isFollowing=!1,r("取消关注")):(await _.addFollow({token:g,followedId:s,followedType:"user"}),e.isFollowing=!0,r("已关注")),console.log("添加关注成功：",e))}catch(e){console.error("关注操作失败：",e)}},X=async s=>{console.log("params传参：",s);try{if(s.isFavorite)await _.removeFavoriteSong({token:localStorage.getItem("TOKEN"),songId:s.song_id});else{const a=(await oe.getSingerDetail(s.artist_id)).artist.img1v1Url,l={token:localStorage.getItem("TOKEN"),songId:s.song_id,songName:s.song_name,artistId:s.artist_id,artistName:s.artist_name,artistImg:a,albumId:s.album_id,albumName:s.album_name,albumImg:s.album_img,songNum:s.song_num};console.log("添加收藏参数：",l),await _.addFavoriteSong(l)}s.isFavorite=!s.isFavorite,r(s.isFavorite?"已收藏":"已取消收藏")}catch(e){console.error("切换收藏状态失败:",e),r("操作失败")}};return Se(async()=>{A(),localStorage.getItem("TOKEN")||se({title:"提示",message:"登录已失效，请重新登录",confirmButtonColor:"#20a162",confirmButtonText:"跳转登录",cancelButtonText:"否"}).then(()=>{z.push("/login")}).catch(()=>{console.log("取消")})}),(s,e)=>{const a=I("van-skeleton"),l=I("van-icon"),C=I("van-button"),P=I("van-swipe-cell"),Z=I("van-tab"),ee=I("van-pull-refresh"),ke=I("van-tabs"),we=I("van-list"),Ce=I("van-popup");return c(),i("div",{class:B(["community",{"color-theme":!S.value}])},[o("div",Ee,[u(ke,{active:K.value,"onUpdate:active":e[2]||(e[2]=t=>K.value=t),color:"#20a162","title-active-color":"#20a162","line-width":"40px",sticky:""},{default:f(()=>[u(ee,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=t=>T.value=t),"success-text":"刷新成功",onRefresh:G},{default:f(()=>[(c(),i(N,null,L(3,t=>u(a,{title:"",avatar:"",row:4,"title-width":"['60%']","row-width":"['100%', '100%', '100%', '40%']","avatar-size":"45px","avatar-shape":"round",loading:S.value},null,8,["loading"])),64)),u(Z,{title:"广场"},{default:f(()=>[(c(!0),i(N,null,L(m.value,t=>(c(),i("div",{class:"list",key:t.post_id,onClick:n=>j(t.user_id)},[u(P,{disabled:t.user_id!=b(y),"before-close":({position:n})=>q({position:n},t)},{right:f(()=>[u(C,{square:"",text:"删除",color:"#f1f5f8",class:"delete-button"})]),default:f(()=>[o("div",Ue,[o("div",Ve,[o("div",Me,[o("div",Ae,[o("img",{src:t.user_avatar,alt:""},null,8,Be)]),o("div",ze,d(t.user_name),1),t.user_id==b(y)?(c(),i("div",Oe,"我的帖子")):k("",!0),o("div",Ke,d(t.created_at),1)]),o("div",Ge,[t.user_id!=b(y)?(c(),i("div",{key:0,class:B(["concern",{followed:t.isFollowing}]),onClick:v(n=>ye(t.user_id),["stop"])},[o("i",{style:Ne({display:t.isFollowing?"none":"block"})},e[6]||(e[6]=[o("img",{src:De,alt:""},null,-1)]),4),o("span",null,d(t.isFollowing?"已关注":"关注"),1)],10,je)):k("",!0)])]),o("div",qe,d(t.content),1),o("div",Ye,[o("div",Je,[o("i",{onClick:v(n=>Q(t),["stop"])},[t.isPlaying?(c(),i("img",Qe)):(c(),i("img",He))],8,We),o("img",{src:t.album_img,alt:""},null,8,Xe)]),o("div",Ze,[o("div",es,d(t.song_name),1),o("div",ss,d(t.artist_name),1)]),o("div",{class:"collect",onClick:v(n=>X(t),["stop"])},[t.isFavorite?(c(),i("img",ts)):(c(),i("img",as))],8,os)]),o("div",ns,[o("div",{class:"btn",onClick:v(n=>Y(t),["stop"])},[o("i",null,[u(l,{size:"27",name:t.isLiked?"good-job":"good-job-o",color:t.isLiked?"#e5404f":""},null,8,["name","color"])]),o("span",null,d(t.like_count),1)],8,ls),o("div",is,[o("i",{onClick:v(n=>J(t),["stop"])},e[7]||(e[7]=[o("img",{src:ne,alt:""},null,-1)]),8,cs),o("span",null,d(t.comment_count),1)])])])]),_:2},1032,["disabled","before-close"])],8,Pe))),128)),m.value.length===0?(c(),i("div",rs,"暂无发布动态~")):k("",!0)]),_:1})]),_:1},8,["modelValue"]),u(ee,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=t=>T.value=t),"success-text":"刷新成功",onRefresh:G},{default:f(()=>[(c(),i(N,null,L(3,t=>u(a,{title:"",avatar:"",row:4,"title-width":"['60%']","row-width":"['100%', '100%', '100%', '40%']","avatar-size":"45px","avatar-shape":"round",loading:S.value},null,8,["loading"])),64)),u(Z,{title:"我的"},{default:f(()=>[(c(!0),i(N,null,L(D.value,t=>(c(),i("div",{class:"list",key:t.post_id,onClick:n=>j(t.user_id)},[u(P,{"before-close":({position:n})=>q({position:n},t)},{right:f(()=>[u(C,{square:"",text:"删除",color:"#f1f5f8",class:"delete-button"})]),default:f(()=>[o("div",_s,[o("div",us,[o("div",vs,[o("div",ms,[o("img",{src:t.user_avatar,alt:""},null,8,gs)]),o("div",hs,d(t.user_name),1),o("div",ps,d(t.created_at),1)])]),o("div",fs,d(t.content),1),o("div",ys,[o("div",ks,[o("i",{onClick:v(n=>Q(t),["stop"])},[t.isPlaying?(c(),i("img",Is)):(c(),i("img",Cs))],8,ws),o("img",{src:t.album_img,alt:""},null,8,bs)]),o("div",Fs,[o("div",Ss,d(t.song_name),1),o("div",xs,d(t.artist_name),1)]),o("div",{class:"collect",onClick:v(n=>X(t),["stop"])},[t.isFavorite?(c(),i("img",Ls)):(c(),i("img",$s))],8,Ns)]),o("div",Rs,[o("div",{class:"btn",onClick:v(n=>Y(t),["stop"])},[o("i",null,[u(l,{size:"27",name:t.isLiked?"good-job":"good-job-o",color:t.isLiked?"#e5404f":""},null,8,["name","color"])]),o("span",null,d(t.like_count),1)],8,Ts),o("div",Ds,[o("i",{onClick:v(n=>J(t),["stop"])},e[8]||(e[8]=[o("img",{src:ne,alt:""},null,-1)]),8,Es),o("span",null,d(t.comment_count),1)])])])]),_:2},1032,["before-close"])],8,ds))),128)),D.value.length===0?(c(),i("div",Ps,"暂无发布动态~")):k("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["active"])]),u(Ce,{show:$.value,"onUpdate:show":e[5]||(e[5]=t=>$.value=t),round:"",position:"bottom",style:{height:"30%"}},{default:f(()=>[o("div",Us,[o("div",Vs,[e[9]||(e[9]=o("span",{class:"comment"},"评论",-1)),o("span",Ms,d(w.value.comment_count),1)]),u(we,{class:B({"no-comment":x.value.length===0}),loading:S.value,"onUpdate:loading":e[3]||(e[3]=t=>S.value=t),finished:O.value,"finished-text":x.value.length===0?"暂无评论~":"没有更多了",onLoad:he},{default:f(()=>[o("div",As,[(c(!0),i(N,null,L(x.value,t=>(c(),i("div",{class:"comment-item",onClick:v(n=>_e(t),["stop"]),key:t.id},[o("div",zs,[o("img",{src:t.user_avatar,alt:t.user_avatar},null,8,Os)]),o("div",Ks,[o("div",Gs,[o("div",js,d(t.user_name),1),t.user_id==t.postAuthorId?(c(),i("div",qs,"作者")):k("",!0),o("div",Ys,d(t.created_at),1),t.user_id==b(y)?(c(),i("i",{key:1,onClick:v(n=>ve(t.id),["stop"]),class:"delete-icon"},e[10]||(e[10]=[o("img",{src:te,alt:"删除"},null,-1)]),8,Js)):k("",!0)]),o("div",Ws,d(t.content),1),t.replies&&t.replies.length?(c(),i("div",Hs,[ae(o("div",Qs,[(c(!0),i(N,null,L(t.replies,n=>(c(),i("div",{key:n.id,class:"reply-item",onClick:v(Ie=>ue(n),["stop"])},[o("img",{src:n.user_avatar,class:"reply-avatar"},null,8,Zs),o("div",eo,[o("div",so,[o("div",oo,d(n.user_name),1),n.user_id==n.postAuthorId?(c(),i("div",to,"作者")):k("",!0),o("div",ao,d(n.created_at),1),n.user_id==b(y)?(c(),i("i",{key:1,onClick:v(Ie=>me(n.id),["stop"]),class:"delete-icon"},e[11]||(e[11]=[o("img",{src:te,alt:"删除"},null,-1)]),8,no)):k("",!0)]),o("div",lo,[n.reply_to_user_name&&n.reply_to_user_name!==n.user_name?(c(),i("div",io,[e[12]||(e[12]=$e(" 回复 ")),o("span",co,d(n.reply_to_user_name),1)])):k("",!0),o("div",ro,d(n.content),1)])])],8,Xs))),128))],512),[[Le,t.expanded]]),o("div",{class:"reply-count",onClick:v(n=>ge(t),["stop"])},d(t.expanded?"收起":`展开${t.replies.length}条回复`),9,_o)])):k("",!0)])],8,Bs))),128))])]),_:1},8,["class","loading","finished","finished-text"]),o("div",uo,[o("div",vo,[o("img",{src:b(de),alt:"头像"},null,8,mo)]),o("div",go,[ae(o("input",{type:"text",placeholder:p.value&&R.value&&p.value.name!=b(V)?`${b(V)}... 回复 ${p.value.name}`:`${b(V)}... 发表评论`,"onUpdate:modelValue":e[4]||(e[4]=t=>F.value=t),onKeyup:Te(W,["enter"])},null,40,ho),[[Re,F.value]])]),o("div",{class:"right-box",onClick:W},e[13]||(e[13]=[o("p",null,"回复",-1)]))])])]),_:1},8,["show"])],2)}}},bo=be(po,[["__scopeId","data-v-3ac3cff5"]]);export{bo as default};
